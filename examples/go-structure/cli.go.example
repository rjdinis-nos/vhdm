// Example: internal/cli/cli.go
// Root command and global configuration

package cli

import (
	"github.com/spf13/cobra"
	"github.com/user/vhdm/internal/config"
	"github.com/user/vhdm/internal/logging"
	"github.com/user/vhdm/internal/tracking"
	"github.com/user/vhdm/internal/wsl"
)

// AppContext holds shared application state
type AppContext struct {
	Config  *config.Config
	Logger  *logging.Logger
	Tracker *tracking.Tracker
	WSL     *wsl.Client
}

// Global flags
var (
	quiet   bool
	debug   bool
	yes     bool
	appCtx  *AppContext
)

// NewRootCommand creates the root command
func NewRootCommand(version, commit, date string) *cobra.Command {
	rootCmd := &cobra.Command{
		Use:   "vhdm",
		Short: "WSL VHD Disk Management Tool",
		Long: `vhdm is a comprehensive CLI for managing VHD/VHDX files in WSL2.

Operations include attach, mount, format, unmount, detach, create, delete, 
resize, status, history, and sync.`,
		Version: version,
		PersistentPreRunE: func(cmd *cobra.Command, args []string) error {
			// Initialize application context
			var err error
			appCtx, err = initContext()
			if err != nil {
				return err
			}
			
			// Auto-sync mappings if enabled
			if appCtx.Config.AutoSyncMappings {
				appCtx.Tracker.SyncMappingsSilent()
			}
			
			return nil
		},
	}

	// Global flags
	rootCmd.PersistentFlags().BoolVarP(&quiet, "quiet", "q", false, "Run in quiet mode (minimal output)")
	rootCmd.PersistentFlags().BoolVarP(&debug, "debug", "d", false, "Run in debug mode (show commands)")
	rootCmd.PersistentFlags().BoolVarP(&yes, "yes", "y", false, "Auto-confirm prompts")

	// Add subcommands
	rootCmd.AddCommand(
		newAttachCmd(),
		newDetachCmd(),
		newMountCmd(),
		newUmountCmd(),
		newFormatCmd(),
		newStatusCmd(),
		newCreateCmd(),
		newDeleteCmd(),
		newResizeCmd(),
		newHistoryCmd(),
		newSyncCmd(),
	)

	return rootCmd
}

// initContext initializes the application context
func initContext() (*AppContext, error) {
	// Load configuration
	cfg, err := config.Load()
	if err != nil {
		return nil, err
	}
	
	// Apply global flags
	cfg.Quiet = quiet
	cfg.Debug = debug
	cfg.Yes = yes
	
	// Create logger
	logger := logging.New(cfg.Quiet, cfg.Debug)
	
	// Create tracker
	tracker, err := tracking.New(cfg.TrackingFile)
	if err != nil {
		return nil, err
	}
	
	// Create WSL client
	wslClient := wsl.NewClient(logger)
	
	return &AppContext{
		Config:  cfg,
		Logger:  logger,
		Tracker: tracker,
		WSL:     wslClient,
	}, nil
}

